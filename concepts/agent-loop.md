# Agent 运行循环 (Agent Loop)

Agent 运行循环是 Agent 的一次完整生命周期：**输入接收 → 上下文组装 → 模型推理 → 工具执行 → 流式回复 → 持久化保存**。它是将消息转化为行动和最终回复的核心路径。

## 运行流程 (高层视角)
1. **验证与解析**：网关验证参数，解析对应的会话 ID 和工作空间。
2. **环境准备**：加载技能（Skills）快照，注入环境变量，锁定会话以防止并发冲突。
3. **Prompt 组装**：将系统基础提示词、技能说明、用户引导文件（如 \`SOUL.md\`）及历史消息拼接。
4. **推理与执行**：
   - **模型推理**：模型根据上下文输出文本或工具调用指令。
   - **工具执行**：网关代为执行 shell、文件或浏览器工具，并将结果返回给模型。
5. **流式输出**：在推理过程中，回复内容会实时流式传输到客户端或通讯频道。
6. **清理与保存**：运行结束，保存会话历史，释放资源。

## 队列与并发
- **会话串行化**：每个会话 ID (Session Key) 同时只能运行一个循环。这确保了历史记录的顺序性和逻辑一致性。
- **全局队列**：通过网关队列管理多用户或多频道的并发请求。

## 拦截与扩展 (Hooks)
你可以通过以下方式介入运行循环：
- **内部钩子**：如 \`agent:bootstrap\`，在生成 Prompt 之前修改上下文。
- **插件钩子**：如 \`before_tool_call\` 或 \`agent_end\`，监控或拦截工具调用及最终输出。

## 超时机制
- **默认超时**：Agent 单次运行上限默认为 600 秒（可在 \`agents.defaults.timeoutSeconds\` 中修改）。
- **手动取消**：支持通过 AbortSignal 随时中断运行中的循环。
